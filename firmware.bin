#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <UniversalTelegramBot.h>

#include <HTTPClient.h>
#include <HTTPUpdate.h>

#include <U8g2lib.h>
#include <Wire.h>

/* ================== WiFi ================== */
const char* ssid = "DESKTOP-T53V366 5504";
const char* password = "hellothere";

/* ================== Telegram ================== */
#define BOT_TOKEN "8459877549:AAFngvqXcXGxkFvjU8lP7SMfPPHZhp0eBTY"
#define CHAT_ID  "8441164057"

/* ================== OTA ================== */
#define OTA_URL "https://raw.githubusercontent.com/SnowFox-42/esp32-ota-bin/main/firmware.bin"

/* ================== DonanÄ±m ================== */
#define LED_PIN 23

/* ================== Telegram ================== */
WiFiClientSecure telegramClient;
UniversalTelegramBot bot(BOT_TOKEN, telegramClient);

/* ================== OLED ================== */
U8G2_SSD1306_128X64_NONAME_F_HW_I2C oled(
  U8G2_R0,
  U8X8_PIN_NONE
);

#define OLED_MAX_LINES 5
String oledLines[OLED_MAX_LINES];

/* ================== OLED KAYDIRARAK YAZ ================== */
void oledScrollPrint(String text) {
  for (int i = 0; i < OLED_MAX_LINES - 1; i++) {
    oledLines[i] = oledLines[i + 1];
  }
  oledLines[OLED_MAX_LINES - 1] = text;

  oled.clearBuffer();
  oled.setFont(u8g2_font_unifont_t_extended);

  for (int i = 0; i < OLED_MAX_LINES; i++) {
    oled.drawUTF8(0, (i + 1) * 12, oledLines[i].c_str());
  }

  oled.sendBuffer();
}

/* ================== OLED TEMÄ°ZLEYÄ°P TEK MESAJ ================== */
void oledClearAndWrite(String text) {
  for (int i = 0; i < OLED_MAX_LINES; i++) {
    oledLines[i] = "";
  }

  oled.clearBuffer();
  oled.setFont(u8g2_font_unifont_t_extended);
  oled.drawUTF8(0, 12, text.c_str());
  oled.sendBuffer();
}

/* ================== OTA ================== */
void startOTA() {
  oledScrollPrint("OTA basliyor");
  bot.sendMessage(CHAT_ID, "â¬†ï¸ OTA baslatildi", "");

  WiFiClientSecure otaClient;
  otaClient.setInsecure();

  t_httpUpdate_return ret = httpUpdate.update(otaClient, OTA_URL);

  if (ret == HTTP_UPDATE_FAILED) {
    oledScrollPrint("OTA HATA");
    bot.sendMessage(CHAT_ID, "âŒ OTA basarisiz", "");
  }
  else if (ret == HTTP_UPDATE_NO_UPDATES) {
    oledScrollPrint("Guncelleme yok");
    bot.sendMessage(CHAT_ID, "â„¹ï¸ Guncelleme yok", "");
  }
  else if (ret == HTTP_UPDATE_OK) {
    oledScrollPrint("OTA OK");
  }
}

/* ================== SETUP ================== */
void setup() {
  Serial.begin(115200);
  pinMode(LED_PIN, OUTPUT);

  Wire.begin(21, 22);

  oled.begin();
  oled.clearBuffer();
  oledScrollPrint("ESP32 basladi");

  WiFi.begin(ssid, password);
  oledScrollPrint("WiFi baglaniyor");

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
  }

  oledScrollPrint("WiFi baglandi");

  telegramClient.setInsecure();
  bot.sendMessage(CHAT_ID, "ðŸ¤– ESP32 Online!", "");
}

/* ================== LOOP ================== */
void loop() {
  int newMessages = bot.getUpdates(bot.last_message_received + 1);

  for (int i = 0; i < newMessages; i++) {
    String text = bot.messages[i].text;

    if (text == "/on") {
      digitalWrite(LED_PIN, HIGH);
      oledScrollPrint("LED acildi");
      bot.sendMessage(CHAT_ID, "ðŸ’¡ LED AÃ‡ILDI", "");
    }

    else if (text == "/off") {
      digitalWrite(LED_PIN, LOW);
      oledScrollPrint("LED kapandi");
      bot.sendMessage(CHAT_ID, "ðŸ’¡ LED KAPANDI", "");
    }

    else if (text == "/status") {
      String durum = digitalRead(LED_PIN) ? "LED ACIK" : "LED KAPALI";
      oledScrollPrint(durum);
      bot.sendMessage(CHAT_ID, durum, "");
    }

    else if (text == "/update") {
      startOTA();
    }

    else if (text.startsWith("/yaz ")) {
      String mesaj = text.substring(5);
      oledClearAndWrite(mesaj);
      bot.sendMessage(CHAT_ID, "ðŸ–¥ï¸ OLED'e yazildi", "");
    }
  }

  delay(1000);
}
